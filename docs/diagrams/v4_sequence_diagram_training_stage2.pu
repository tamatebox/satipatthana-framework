@startuml v4_sequence_diagram_training_stage2
!theme plain
hide footbox
skinparam sequenceMessageAlign center

participant "User/Trainer" as Trainer
participant "SamadhiSystem" as System
participant "SamathaEngine" as Samatha
participant "VipassanaEngine" as Vipassana

== Stage 2: Vipassana Training (Meta-Cognition) ==
note over Trainer, Vipassana
Goal: Learn to distinguish valid/invalid trajectories.
Loss: Binary Cross Entropy (Contrastive)
Noise Strategies: Augmented(Ambiguity), Drunk(Dysfunction), Mismatch(Hallucination)
end note

Trainer -> System: forward(x, stage="2_vipassana_gen")
activate System
    note right of System: 1. Generate clean logs (Batch)
    System -> Samatha: forward(x)
    Samatha --> System: s_star_clean, santana_clean
System --> Trainer: clean_data (s*, santana)
deactivate System

Trainer -> Trainer: Create Noise Data
group Noise Generation Strategies
    Trainer -> System: forward(x, noise_level=High) -> Augmented Santana (Target=Low)
    Trainer -> System: forward(x, drunk_mode=True) -> Drunk Santana (Target=0.0)
    
    alt use_label_guidance is True (Supervised)
        Trainer -> Trainer: Create Mismatch (Hallucination)\nCross-Label Shuffle: Combine S*_A with Santana_B\nwhere Label(A) != Label(B)
    else Unsupervised Mode
        Trainer -> Trainer: Create Mismatch (Hallucination)\nRandom Shuffle: Combine S*_A with Santana_Random
    end
end

Trainer -> System: forward(s_star_batch, santana_batch, stage="2_vipassana_train")
activate System
    System -> Vipassana: forward(s_star_batch, santana_batch)
    activate Vipassana
    Vipassana --> System: v_ctx, trust_scores
    deactivate Vipassana
System --> Trainer: trust_scores
deactivate System

Trainer -> Trainer: Compute Loss:\n BCE(trust_scores, targets)
Trainer -> System: backward()
note right of Trainer: Optimize Vipassana Only

@enduml